name: Build and Push

on:
  push:
    branches:
      - main

env:
  IMAGE: "harbor.rp-taki.com/rp-taki/myfirstgithubactionrunner:latest"
  REGISTRY: "harbor.rp-taki.com"

jobs:
  build:
    runs-on: arc-runner-set
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true # ローカルのDocker daemonに読み込む
          tags: ${{ env.IMAGE }}

      - name: Save image
        run: docker save ${{ env.IMAGE }} -o image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  scan:
    runs-on: arc-runner-set
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      # Trivyのインストール (バイナリを直接取得)
      - name: Install Trivy
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Installing Trivy $VERSION"
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/${VERSION}/trivy_${VERSION#v}_Linux-64bit.tar.gz | tar xz -C /usr/local/bin trivy

      - name: Scan image
        run: |
          # 脆弱性が検出されてもジョブを継続させる場合は --exit-code 0 に設定
          # 致命的な脆弱性(CRITICAL)がある場合にジョブを失敗させたい場合は --exit-code 1 を使用
          trivy image --exit-code 0 --severity HIGH,CRITICAL --no-progress ${{ env.IMAGE }}

      - name: Check image list
        run: docker images

  push:
    runs-on: arc-runner-set
    needs: scan
    outputs:
      image_digest: ${{ steps.push_step.outputs.digest }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image
        run: docker load -i image.tar

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Push image
        id: push_step
        run: |
          docker push ${{ env.IMAGE }}
          # 署名に使用するため、プッシュ後のダイジェスト値を抽出
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ env.IMAGE }} | cut -d'@' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

  sign:
    runs-on: arc-runner-set
    needs: push
    permissions:
      id-token: write   # Keyless署名（OIDC認証）に必須
      contents: read    # リポジトリ読み取り権限
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.0

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Sign the image (Keyless)
        env:
          # pushジョブから渡されたDigestを使用
          IMAGE_WITH_DIGEST: "${{ env.IMAGE }}@${{ needs.push.outputs.image_digest }}"
        run: |
          # 鍵を指定せずに実行。COSIGN_PASSWORD等も不要です。
          # 実行時に一時的な証明書が発行され、署名が行われます。
          cosign sign --yes ${IMAGE_WITH_DIGEST}
